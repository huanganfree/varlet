import{H as he,u as we}from"./index-8c8e5e90.js";import{F as be,u as Ve}from"./provide-bd6f36e3.js";import{I as Pe}from"./index-d9f34410.js";import{P as Re}from"./index-3494baee.js";import{I as Q}from"./index-9279bfdb.js";import{v as Be}from"./index-85ab28c6.js";import{H as $e}from"./index-2a9d0a0e.js";import{d as f,h as ke,a as u,f as Ce,c as De,w as Se}from"./components-b4bea23d.js";import{d as Le,r as z,D as X,ae as Ue,G as Te,a4 as M,W as b,aU as A,n as Fe,b9 as He,_ as Ne,b as D,L as Y,e as p,m as g,p as P,N as ze,O as Me,P as Z,x as i,R as Ae,M as Ie,q as R,t as S,y as _,v as x,aP as Ee,w as ee}from"./index-ba2bae36.js";import{i as ae,a as oe}from"./shared-104f51c5.js";import{a as Oe}from"./elements-75b8c791.js";const We={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:Boolean,readonly:Boolean,disabled:Boolean,elevation:{type:[Boolean,Number,String],default:!0},resolveType:{type:String,default:"default"},removable:{type:Boolean,default:!0},maxlength:[Number,String],maxsize:[Number,String],previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:Array,hideList:Boolean,preventDefaultPreview:Boolean,onBeforeFilter:f(),onBeforeRead:f(),onAfterRead:f(),onBeforeRemove:f(),onRemove:f(),onOversize:f(),onPreview:f(),"onUpdate:modelValue":f()},{name:je,n:qe,classes:Ge}=De("uploader");let Je=0;const Ke=Le({name:je,directives:{Ripple:Be,Hover:$e},components:{VarIcon:Pe,VarPopup:Re,VarFormDetails:be,VarHoverOverlay:he},props:We,setup(e){const d=z(null),B=z(!1),$=z(null),I=X(()=>{const{maxlength:a,modelValue:{length:r}}=e;return Ue(a)?`${r} / ${a}`:""}),{form:l,bindForm:k}=Ve(),{errorMessage:L,validateWithTrigger:U,validate:T,resetValidation:y}=ke(),{hovering:F,handleHovering:o}=we(),h=X(()=>{const{modelValue:a,hideList:r}=e;return r?[]:a});let H=!1;const E={getSuccess:O,getError:W,getLoading:j};u(k,{validate:G,resetValidation:y,reset:J}),Te(()=>e.modelValue,()=>{!H&&q("onChange"),H=!1},{deep:!0});function le(a){const{disabled:r,previewed:n,preventDefaultPreview:t,onPreview:c}=e;if(l!=null&&l.disabled.value||r||!n||(u(c,b(a)),t))return;const{url:v}=a;if(oe(v)){Q(v);return}ae(v)&&($.value=a,B.value=!0)}function re(a){return{id:Je++,url:"",cover:"",name:a.name,file:a,progress:0}}function ne(a){const r=a.target,{files:n}=r;return Array.from(n)}async function se(a){const r=a.file;if(e.resolveType==="default"&&r.type.startsWith("image")||e.resolveType==="data-url"){const t=await He(r);a.cover=t,a.url=t}return a}function te(a){return a.map(se)}function ie(a){const{onBeforeRead:r}=e;return a.map(n=>new Promise(t=>{r||t({valid:!0,varFile:n});const c=A(u(r,b(n)));Promise.all(c).then(v=>{t({valid:v.every(Boolean),varFile:n})})}))}async function de(a){const{maxsize:r,maxlength:n,modelValue:t,onOversize:c,onAfterRead:v,onBeforeFilter:C,readonly:V,disabled:N}=e;if(l!=null&&l.disabled.value||l!=null&&l.readonly.value||N||V)return;const ce=s=>s.filter(w=>w.file.size>M(r)?(u(c,b(w)),!1):!0),fe=s=>{const w=Math.min(s.length,M(n)-t.length);return s.slice(0,w)},pe=async s=>{if(!C)return s;const w=A(C);for(const ye of w)s=await ye(s);return s};let m=ne(a).map(re);m=await pe(m),m=r!=null?ce(m):m,m=n!=null?fe(m):m;const ge=await Promise.all(te(m)),K=(await Promise.all(ie(ge))).filter(({valid:s})=>s).map(({varFile:s})=>s);u(e["onUpdate:modelValue"],[...t,...K]),a.target.value="",K.forEach(s=>u(v,b(s)))}async function ue(a){const{disabled:r,readonly:n,modelValue:t,onBeforeRemove:c,onRemove:v}=e;if(l!=null&&l.disabled.value||l!=null&&l.readonly.value||r||n)return;if(c){const V=A(u(c,b(a)));if((await Promise.all(V)).some(N=>!N))return}const C=t.filter(V=>V!==a);u(v,b(a)),q("onRemove"),u(e["onUpdate:modelValue"],C)}function O(){return e.modelValue.filter(a=>a.state==="success")}function W(){return e.modelValue.filter(a=>a.state==="error")}function j(){return e.modelValue.filter(a=>a.state==="loading")}function ve(){d.value.click()}function me(){$.value=null,B.value=!1,Q.close()}function q(a){Fe(()=>{const{validateTrigger:r,rules:n,modelValue:t}=e;U(r,a,n,t,E)})}function G(){return T(e.rules,e.modelValue,E)}function J(){H=!0,u(e["onUpdate:modelValue"],[]),y()}return{input:d,files:h,showPreview:B,currentPreview:$,errorMessage:L,maxlengthText:I,hovering:F,formDisabled:l==null?void 0:l.disabled,formReadonly:l==null?void 0:l.readonly,n:qe,classes:Ge,formatElevation:Ce,toNumber:M,handleHovering:o,isHTMLSupportVideo:ae,isHTMLSupportImage:oe,preview:le,handleChange:de,handleRemove:ue,getSuccess:O,getError:W,getLoading:j,validate:G,resetValidation:y,reset:J,chooseFile:ve,closePreview:me,toSizeUnit:Oe}}});const Qe=["onClick"],Xe=["onClick"],Ye=["src","alt"],Ze=["multiple","accept","capture","disabled"],_e=["src"];function xe(e,d,B,$,I,l){const k=D("var-icon"),L=D("var-hover-overlay"),U=D("var-form-details"),T=D("var-popup"),y=Y("ripple"),F=Y("hover");return p(),g("div",{class:i(e.classes(e.n(),e.n("$--box")))},[P("div",{class:i(e.n("file-list"))},[(p(!0),g(ze,null,Me(e.files,o=>Z((p(),g("div",{class:i(e.classes(e.n("file"),e.formatElevation(e.elevation,2),[o.state==="loading",e.n("--loading")])),key:o.id,onClick:h=>e.preview(o)},[P("div",{class:i(e.n("file-name"))},Ae(o.name||o.url),3),e.removable?(p(),g("div",{key:0,class:i(e.n("file-close")),onClick:Ie(h=>e.handleRemove(o),["stop"])},[R(k,{class:i(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Xe)):S("",!0),o.cover?(p(),g("img",{key:1,class:i(e.n("file-cover")),style:_({objectFit:o.fit}),src:o.cover,alt:o.name},null,14,Ye)):S("",!0),P("div",{class:i(e.n("file-indicator"))},[P("div",{class:i(e.classes(e.n("progress"),[o.state==="success",e.n("--success")],[o.state==="error",e.n("--error")])),style:_({width:o.state==="success"||o.state==="error"?"100%":`${o.progress}%`})},null,6)],2)],10,Qe)),[[y,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.toNumber(e.maxlength)?Z((p(),g("div",{key:0,class:i(e.classes([!e.$slots.default,`${e.n("action")} ${e.formatElevation(e.elevation,2)}`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:d[1]||(d[1]=(...o)=>e.chooseFile&&e.chooseFile(...o))},[P("input",{ref:"input",type:"file",class:i(e.n("action-input")),multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:d[0]||(d[0]=(...o)=>e.handleChange&&e.handleChange(...o))},null,42,Ze),x(e.$slots,"default",{},()=>[R(k,{class:i(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"]),R(L,{hovering:e.hovering&&!e.disabled&&!e.formDisabled},null,8,["hovering"])])],2)),[[y,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||!!e.$slots.default}],[F,e.handleHovering,"desktop"]]):S("",!0)],2),R(U,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},Ee({_:2},[e.$slots["extra-message"]?{name:"extra-message",fn:ee(()=>[x(e.$slots,"extra-message")]),key:"0"}:void 0]),1032,["error-message","extra-message"]),R(T,{class:i(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":d[2]||(d[2]=o=>e.showPreview=o),onClosed:d[3]||(d[3]=o=>e.currentPreview=null)},{default:ee(()=>{var o,h;return[e.currentPreview&&e.isHTMLSupportVideo((o=e.currentPreview)==null?void 0:o.url)?(p(),g("video",{key:0,class:i(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(h=e.currentPreview)==null?void 0:h.url},null,10,_e)):S("",!0)]}),_:1},8,["class","show"])],2)}const ea=Ne(Ke,[["render",xe]]);Se(ea);export{ea as U};
